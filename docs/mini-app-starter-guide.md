# Приложение Твой ФФ!

# Как создать свое мини-приложение в «Твой ФФ!»

Приложение «Твой ФФ» является платформой для сервисов. Разработчики могут встраивать свои веб-приложения в платформу и получать дополнительные возможности по взаимодействию с аудиторией, а также с данными и с функционалом инфраструктуры «Твой ФФ!». 

В Твой ФФ может быть встроено любое веб-приложение, которое поддерживает встраивание с помощью iFrame, размещено в интернете и поддерживает протокол https. Размещение кнопки входа в приложение на экране сервисов в «Твой ФФ!» курируется Профкомом студентов физического факультета МГУ.

Здесь приведена краткая инструкция, включающая в себя создание своего приложения и его настройку.


## Как создать свое приложение

1. [Соберите приложение и запустите его локально.](https://pages.profcomff.com/mini-app-starter-guide#%D1%81%D0%B1%D0%BE%D1%80%D0%BA%D0%B0-%D0%B8-%D0%BB%D0%BE%D0%BA%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B9-%D0%B7%D0%B0%D0%BF%D1%83%D1%81%D0%BA-%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F)
2. [Проверьте работу приложения локально.](https://pages.profcomff.com/mini-app-starter-guide#%D0%BF%D1%80%D0%BE%D0%B2%D0%B5%D1%80%D1%8C%D1%82%D0%B5-%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D1%83-%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F-%D0%BB%D0%BE%D0%BA%D0%B0%D0%BB%D1%8C%D0%BD%D0%BE)
3. [Разместите мини-приложение на хостинге.](https://pages.profcomff.com/mini-app-starter-guide#%D1%80%D0%B0%D0%B7%D0%BC%D0%B5%D1%89%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F-%D0%BD%D0%B0-%D1%85%D0%BE%D1%81%D1%82%D0%B8%D0%BD%D0%B3%D0%B5)
4. [Зарегистрируйте свое приложение.](https://pages.profcomff.com/mini-app-starter-guide#%D1%80%D0%B5%D0%B3%D0%B8%D1%81%D1%82%D1%80%D0%B0%D1%86%D0%B8%D1%8F-%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F)

Для успешного написания и встраивания своего приложения на платформу хорошо бы также немного понимать ее (платформы) архитектуру.

Ниже описаны фундаментальные детали, которые вам необходимо понимать.

## Важные ссылки
- Quick Start Guide (эта инструкция): <https://pages.profcomff.com/mini-app-starter-guide>
- Тестовый контур Твой ФФ: <https://app.test.profcomff.com/>
- Описание всех API Твой ФФ: <https://api.test.profcomff.com/>
- Форма создания приложения в тестовом контуре: <https://forms.yandex.ru/cloud/64b41d64693872c708de0803/>
- Шаблон сервиса: <https://github.com/profcomff/app-template>

## Основные понятия

Пользовательская сессия или сеанс – это период времени и последовательность взаимодействий, в течение которого пользователь активен на вашем сайте или в приложении.

Каждой сессии взаимно однозначно ставится в соответствие случайная строка – так называемый ***токен***. Токен необходимо передавать в запросах к API в заголовке Authorization, и в зависимости от того, какие на данный конкретный токен “навешаны” права(о них далее), backend платформы будет решать отдать вам ответ или ошибку.

Также у каждого пользователя есть уникальный идентификатор пользователя – ***user id***. Используя его, можно делать различные запросы и получать информацию о конкретном пользователе.


### Скоупы

Помимо этого у пользователя также есть ***скоупы(от англ. scopes – рус. возможности, пределы, границы)***, проще говоря, его права на что-либо.

Каждый сервис приложения может изменяться, обновляться и переделываться. От наличия у конкретного пользователя конкретных скоупов зависит то, может ли данный человек принимать участие в этих действиях.

Скоупы, или же права, пользователя дают возможности для чтения и редактирования конкретных разделов или же добавления туда чего-то нового.

Мы сочли важными для сторонних приложений только *скоупы на чтение* чего-либо. Поэтому на данном на этапе вам предоставляются всевозможные права на чтение любых разделов платформы. Предоставляемые вам скоупы и их описание приведены ниже:

**auth.group.read** — позволяет просматривать группу пользователей

На данном моменте также придется ввести новое понятие – ***группа***. Группа – это некий объект, который включает в себя пользователей. Но это было понятно и из названия. Ее главной отличительной особенностью является существование скоупов, принадлежащих данной группе, а, следовательно, и ее участникам. То есть, если у определенной группы есть некие права, то эти права есть и у всех пользователей, состоящих в ней.

**auth.scope.read** — позволяет просматривать права пользователя

Все верно, это скоуп на чтение скоупов.

**auth.user.read** — позволяет просматривать пользователя

Конкретно обладание данным скоупом дает право на отправку запроса для получения групп, скоупов и методов авторизации конкретного пользователя по его user id.


## Сборка и локальный запуск приложения

В приложение «Твой ФФ!» можно встроить любую веб страницу, находящуюся в интернете и доступную по протоколу https. Например, вы можете разместить приложение, разработанное на Node.js и React. 

Многие уже разработанные для «Твой ФФ!» приложения имеют серверную часть на Python, и пользовательский интерфейс, разработанный на Node.js + Vue 3. Наши наработки доступны в шаблоне приложения в виде [пакета app-template](https://github.com/profcomff/app-template). Далее разберем разработку приложения с использованием данного шаблона.

Более детальные шаги к сборке описаны в документации к пакету. Сейчас же мы пройдемся по основным.

1. (Опционально) Если вы хотите далее опубликовать код на GitHub полезно сначала скопировать репозиторий к себе кнопкой Fork на GitHub. Кнопка доступна в правом верхнем углу страницы репозитория.

2. Создайте папку, где будет хранится ваше приложение. 

3. Откройте приложение "Командная строка" или "Терминал", в зависимости от операционной системы. Перейдите в папку проекта командой ```cd /путь/к/папке```
    
    - Если вы пользователь Windows и создали на рабочем столе папку my_app, то команда будет выглядеть так:  

        ```bash
      cd %userprofile%/Desktop/my_app
        ```

    - Если вы пользователь Linux или MacOS и создали на рабочем столе папку my_app, то команда будет выглядеть следующим образом: 
        
        ```bash
      cd ~/Desktop/my_app
        ```

4. Склонируйте код репозитория к себе на ПК командой ```git clone https://github.com/profcomff/app-template.git .``` (точка в конце означает скачивание кода в текущую папку). Если вы выполнили пункт 1 используйте в команде ссылку из зеленой кнопки "Code" в правом верхнем углу вашего репозитория. 

5. Откройте код в удобной среде разработки. Рекомендуем использовать VSCode, который можно открыть из терминала командой ```code```.

6. Сборка исходного кода в один пакет производится с помощью Docker. В этом случае создается независимый от операционной системы пакет, который можно без проблем разместить на любом сервере. 

    Выполните команду ```make``` для сборки приложения. После окончания выполнения этой команды будет создан новый Docker образ с названием my_app, который можно запустить командой
   ```make
   make run
   ```

    - Сборка приложения
   ```shell
    C:\Users\user\Desktop\my_app> make
    docker compose --file ./cicd/docker-compose.yml build
    [+] Building 4.8s (11/25)
   ```
    - Запуск Docker-образа приложения
   ```shell
    C:\Users\user\Desktop\my_app> make run
    docker compose --file ./cicd/docker-compose.yml down
    docker compose --file ./cicd/docker-compose.yml up --detach
   
    - Network cicd_default      Created
    - Container cicd-app-1      Started
    - Container cicd-database-1 Started
   ```

7. Чтобы запустить приложение, для начала нужно установить необходимые библиотеки и компоненты.

    **Windows**

    - Перейдите в папку backend, используя команду
      ```bash
      cd backend
      ```
    - Затем выполните команду
      ```bash
      python -m venv venv
      ```
      для создания виртуального окружения для python
      ```shell
      C:\Users\user\Desktop\my_app> cd .\backend\
      C:\Users\user\Desktop\my_app\backend> python -m venv venv
      ```
    - После этого активируйте виртуальное окружение командой
      ```bash
      venv/Scripts/activate
      ```

      ```shell
      C:\Users\user\Desktop\my_app\backend> .\venv\Scripts\activate
      (venv) C:\Users\user\Desktop\my_app\backend>
      ```


    - Выполните установку всех необходимых библиотек для бэкенда приложения, используя команду 

      ```bash
      pip install -r requirements.dev.txt -r requirements.txt
      ```

    - Перейдите в папку фронтенда, используя команды:

      ```bash
      (venv) PS C:\Users\user\Desktop\my_app\backend> cd ..
      (venv) PS C:\Users\user\Desktop\my_app> cd frontend
      (venv) PS C:\Users\user\Desktop\my_app\frontend>
      ```
      
    - Установите необходимые компоненты для фронтенда командой 

      ```bash
      npm install
      ```

    **Linux или MacOS:**

    - Установите необходимые компоненты и библиотеки командой
      ```bash
      make configure
      ```

8. Запустите приложение командой ```npm run dev```

9. Перейдите по ссылке из строки Local: <http://localhost:5173/> и наслаждайтесь результатом!



## Проверьте работу приложения локально

Основная сложность локального запуска мини-приложения состоит в необходимости “имитации” работы «Твой ФФ!». На данном этапе мы рассмотрим как имитировать передачу информации о пользователе, который открыл приложение.

Нажатие на кнопку приложения в списке сервисов открывает iframe, в котором прописан адрес вашего приложения. К адресу приложения добавляются get-параметры token, scopes, user_id (подробнее об этих параметрах можно прочитать ниже). Если вы разместили ваше приложение по адресу `https://app.example.com`, то приложение Твой ФФ откроет его, например, следующим образом: `https://app.example.com/?token=abcdefghijklmnopqrstuvwxyz&scopes=services.category.get,services.service.get&user_id=4`. Параметры можно просто добавить к вашему приложению при локальном запуске. Чтобы получить строку с get-параметрами:

1. Зарегистрируйтесь в тестовой среде «Твой ФФ!» по адресу <https://app.test.profcomff.com/auth>. Подтвердите аккаунт и войдите в пользователя (при необходимости).

2. Перейдите в панель администрирования <https://app.test.profcomff.com/admin>. 

3. Нажмите кнопку «скопировать параметры приложения».


## Размещение приложения на хостинге

На данном этапе вам необходимо разместить приложение на каком-либо хостинге, поддерживающем протокол https.

Для этого подойдет любой VPS сервер, который вы можете найти в интернете. Мы рекомендуем использовать VPS сервера на операционной системе linux, для удобства размещения приложений и компонентов использовать Docker.

Чтобы получить SSL сертификаы для поддержки https можно использовать letsencrypt.com, предоставляющие SSL сертификаты бесплатно. Для удобства работы можно использовать веб сервер с встроенной поддержкой этих сертификатов, например Traefik или Caddy. 

Шаблон приложения имеет уже готовые [Dockerfile](https://github.com/profcomff/app-template/blob/main/cicd/Dockerfile) для сборки вашего приложения, файл [docker-compose.production.yml](https://github.com/profcomff/app-template/blob/main/cicd/docker-compose.production.yml) с настройками развертывания приложения с Caddy Server и включенным https, а также базой данных PostgreSQL.


## Регистрация приложения

После развертывания приложения в открытом доступе можно подключить его к тестовой среде Твой ФФ для проверки взаимодействия между платформой и вашим сервисом. Для этого приложение нужно зарегистрировать.

Чтобы зарегистрировать приложение, просто отправьте [форму](https://forms.yandex.ru/cloud/64b41d64693872c708de0803/) для запроса создания кнопки стороннего приложения на платформе «Твой ФФ!»
