# Приложение Твой ФФ!

# Как создать свое мини-приложение в «Твой ФФ!»
Приложение «Твой ФФ» является платформой для сервисов. Разработчики могут встраивать свои веб-приложения в платформу и получать дополнительные возможности по взаимодействию с аудиторией, а также с данными и с функционалом инфраструктуры «Твой ФФ!». 

В Твой ФФ может быть встроено любое веб-приложение, которое поддерживает встраивание с помощью iFrame, размещено в интернете и поддерживает протокол https. Размещение кнопки входа в приложение на экране сервисов в «Твой ФФ!» курируется Профкомом студентов физического факультета МГУ.

Здесь приведена краткая инструкция, включающая в себя создание своего приложения и его настройку.
## Как создать свое приложение
1. Соберите приложение и запустите его локально.
1. Проверьте работу приложения локально.
1. Разместите мини-приложение на хостинге.
1. Зарегистрируйте свое приложение. 


Для успешного написания и встраивания своего приложения на платформу хорошо бы также немного понимать ее(платформы) архитектуру.

Ниже описаны фундаментальные детали, которые вам необходимо понимать.

## Сборка и локальный запуск приложения
В приложение «Твой ФФ!» можно встроить любую веб страницу, находящуюся в интернете и доступную по протоколу https. Например, вы можете разместить приложение, разработанное на Node.js и React. 

Многие уже разработанные для «Твой ФФ!» приложения имеют серверную часть на Python, и пользовательский интерфейс, разработанный на Node.js + Vue 3. Наши наработки доступны в шаблоне приложения в виде [пакета app-template](https://github.com/profcomff/app-template). Далее разберем разработку приложения с использованием данного шаблона.

Более детальные шаги к сборке описаны в документации к пакету. Сейчас же мы пройдемся по основным.

1. (Опционально) Если вы хотите далее опубликовать код на GitHub полезно сначала скопировать репозиторий к себе кнопкой Fork на GitHub. Кнопка доступна в правом верхнем углу страницы репозитория.

1. Создайте папку, где будет хранится ваше приложение. 

1. Откройте приложение "Командная строка" или "Терминал", в зависимости от операционной системы. Перейдите в папку проекта командой cd /путь/к/папке
    
    - Если вы пользователь Windows и создали на рабочем столе папку my_app, то команда будет выглядеть так:  

        ```cd %userprofile%/Desktop/my\_app```

    - Если вы пользователь Linux или MacOS и создали на рабочем столе папку my_app, то команда будет выглядеть следующим образом: 
        
        ```cd ~/Desktop/my_app```

    Ниже приведен пример перехода в папку приложения в ОП Windows.

1. Склонируйте код репозитория к себе на ПК командой ```git clone https://github.com/profcomff/app-template.git .``` (точка в конце означает скачивание кода в текущую папку). Если вы выполнили пункт 1 используйте в команде ссылку из зеленой кнопки "Code" в правом верхнем углу вашего репозитория. 

1. Откройте код в удобной среде разработки. Рекомендуем использовать VSCode, который можно открыть из терминала командой ```code```.

1. Сборка исходного кода в один пакет производится с помощью Docker. В этом случае создается независимый от операционной системы пакет, который можно без проблем разместить на любом сервере. 

    Выполните команду make для сборки приложения. После окончания выполнения этой команды будет создан новый Docker образ с названием my_app, который можно запустить командой ```make run```

    - Сборка приложения


    - Запуск Docker-образа приложения

1. Чтобы запустить приложение, для начала нужно установить необходимые библиотеки и компоненты.

    ### Windows

    - Перейдите в папку backend, используя команду ```cd backend```
    - Затем выполните команду ```python -m venv venv``` для создания виртуального окружения для python
    - После этого активируйте виртуальное окружение командой ```venv/Scripts/activate```


    - Выполните установку всех необходимых библиотек для бэкенда приложения, используя команду 

      ```pip install -r requirements.dev.txt -r requirements.txt```

    - Перейдите в папку фронтенда, используя команды:

      ```cd .. ```

      ```cd frontend```

    - Установите необходимые компоненты для фронтенда командой 

      ```npm install```

    ### Linux или MacOS:

    - Установите необходимые компоненты и библиотеки командой ```make configure```

1. Запустите приложение командой ```npm run dev```

1. Перейдите по ссылке из строки Local: http://localhost:5173/ и наслаждайтесь результатом!

## Проверьте работу приложения локально
Основная сложность локального запуска мини-приложения состоит в необходимости “имитации” работы Твой ФФ. На данном этапе мы рассмотрим как имитировать передачу информации о пользователе, который открыл приложение.

Нажатие на кнопку приложения в списке сервисов открывает iframe, в котором прописан адрес вашего приложения. К адресу приложения добавляются get-параметры token, scopes, user\_id (подробнее об этих параметрах можно прочитать ниже). Если вы разместили ваше приложение по адресу <https://app.example.com>, то приложение Твой ФФ откроет его, например, следующим образом: <https://app.example.com/?token=abcdefghijklmnopqrstuvwxyz&scopes=services.category.get,services.service.get&user_id=4>. Параметры можно просто добавить к вашему приложению при локальном запуске. Чтобы получить строку с get-параметрами:

1. Зарегистрируйтесь в тестовой среде «Твой ФФ!» по адресу <https://app.test.profcomff.com/auth>. Подтвердите аккаунт и войдите в пользователя (при необходимости).  
1. Перейдите в панель администрирования <https://app.test.profcomff.com/admin>. 
1. Нажмите кнопку «скопировать параметры приложения».

## Размещение приложения на хостинге
На данном этапе вам необходимо разместить приложение на каком-либо хостинге, поддерживающем протокол https.

Для этого подойдет любой VPS сервер, который вы можете найти в интернете. Мы рекомендуем использовать VPS сервера на операционной системе linux, для удобства размещения приложений и компонентов использовать Docker.

Чтобы получить SSL сертификаы для поддержки https можно использовать neverssl.com или letsencrypt.com, предоставляющие SSL сертификаты бесплатно. Для удобства работы можно использовать веб сервер с встроенной поддержкой этих сертификатов, например Traefik или Caddy. 

Шаблон приложения имеет уже готовые [Dockerfile ](https://github.com/profcomff/app-template/blob/main/cicd/Dockerfile)для сборки вашего приложения, файл [docker-compose.production.yml](https://github.com/profcomff/app-template/blob/main/cicd/docker-compose.production.yml) с настройками развертывания приложения с Caddy Server и включенным https, а также базой данных PostgreSQL.

## Регистрация приложения
После развертывания приложения в открытом доступе можно подключить его к тестовой среде Твой ФФ для проверки взаимодействия между платформой и вашим сервисом. Для этого приложение нужно зарегистрировать.

Чтобы зарегистрировать приложение, просто отправьте [форму](https://forms.yandex.ru/cloud/64b41d64693872c708de0803/) для запроса создания кнопки стороннего приложения на платформе «Твой ФФ!»

### Основные понятия
Пользовательская сессия или сеанс – это период времени и последовательность взаимодействий, в течение которого пользователь активен на вашем сайте или в приложении.

Каждой сессии взаимно однозначно ставится в соответствие случайная строка – так называемый ***токен***. Токен необходимо передавать в запросах к API в заголовке Authorization, и в зависимости от того, какие на данный конкретный токен “навешаны” права(о них далее), backend платформы будет решать отдать вам ответ или ошибку.

Также у каждого пользователя есть уникальный идентификатор пользователя – ***user id***. Используя его, можно делать различные запросы и получать информацию о конкретном пользователе.
### Скоупы
Помимо этого у пользователя также есть ***скоупы(от англ. scopes – рус. возможности, пределы, границы)***, проще говоря, его права на что-либо.

Каждый сервис приложения может изменяться, обновляться и переделываться. От наличия у конкретного пользователя конкретных скоупов зависит то, может ли данный человек принимать участие в этих действиях.

Скоупы, или же права, пользователя дают возможности для чтения и редактирования конкретных разделов или же добавления туда чего-то нового.

Мы сочли важными для сторонних приложений только *скоупы на чтение* чего-либо. Поэтому на данном на этапе вам предоставляются всевозможные права на чтение любых разделов платформы. Предоставляемые вам скоупы и их описание приведены ниже:

**auth.group.read** — позволяет просматривать группу пользователей

На данном моменте также придется ввести новое понятие – ***группа***. Группа – это некий объект, который включает в себя пользователей. Но это было понятно и из названия. Ее главной отличительной особенностью является существование скоупов, принадлежащих данной группе, а, следовательно, и ее участникам. То есть, если у определенной группы есть некие права, то эти права есть и у всех пользователей, состоящих в ней.

**auth.scope.read** — позволяет просматривать права пользователя

Все верно, это скоуп на чтение скоупов.

**auth.user.read** — позволяет просматривать пользователя

Конкретно обладание данным скоупом дает право на отправку запроса для получения групп, скоупов и методов авторизации конкретного пользователя по его user id.



















